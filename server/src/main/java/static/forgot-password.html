<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên Mật khẩu</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .forgot-container { max-width: 400px; margin: 5rem auto; padding: 0 1rem; }
        .status-message { 
            text-align: center; 
            margin-top: 1rem; 
            display: none; 
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .success { 
            color: #155724; 
            background-color: #d4edda; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            color: #721c24; 
            background-color: #f8d7da; 
            border: 1px solid #f5c6cb; 
        }
        /* Style cho nút khi đang loading */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <a href="login.html" class="logo">HiAn</a>
    </header>

    <main class="forgot-container">
        <form id="forgot-form">
            <h2 style="text-align: center;">Đặt lại Mật khẩu</h2>
            <p style="text-align: center; color: #666; font-size: 0.95rem; margin-bottom: 2rem;">
                Nhập email đã đăng ký của bạn. Chúng tôi sẽ gửi một liên kết để đặt lại mật khẩu.
            </p>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" class="form-control" placeholder="vidu@email.com" required>
            </div>

            <button type="submit" id="submit-button" class="btn btn-primary" style="width: 100%;">Gửi link xác nhận</button>

            <div id="status-message" class="status-message"></div>
        </form>
        <p style="text-align: center; margin-top: 1.5rem;">
            <a href="login.html" style="text-decoration: none;">&larr; Quay lại Đăng nhập</a>
        </p>
    </main>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/api.js"></script> 
    <script>
        // Hàm gọi API (Đã tùy chỉnh để xử lý lỗi Tiếng Việt)
        async function forgotPassword(email) {
            // Giả sử API_BASE_URL đã được định nghĩa trong config.js
            // Nếu chưa có, hãy thay thế dòng dưới bằng URL thật: const url = 'http://localhost:8080/api/auth/forgot-password';
            const url = `${API_BASE_URL}/auth/forgot-password`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();

                if (!response.ok) {
                    // --- XỬ LÝ DỊCH LỖI SANG TIẾNG VIỆT ---
                    let errorMessage = "Đã có lỗi xảy ra.";

                    switch (response.status) {
                        case 404:
                            errorMessage = "Email này chưa được đăng ký trong hệ thống.";
                            break;
                        case 400:
                            errorMessage = "Định dạng email không hợp lệ hoặc yêu cầu bị lỗi.";
                            break;
                        case 429:
                            errorMessage = "Bạn đã gửi quá nhiều yêu cầu. Vui lòng thử lại sau ít phút.";
                            break;
                        case 500:
                            errorMessage = "Lỗi máy chủ nội bộ. Vui lòng liên hệ quản trị viên.";
                            break;
                        default:
                            // Nếu API trả về message tiếng Anh, ta có thể hiển thị hoặc dùng câu chung chung
                            errorMessage = data.message || `Lỗi không xác định (${response.status})`;
                    }
                    
                    throw new Error(errorMessage);
                }

                return data;

            } catch (error) {
                // Bắt lỗi mạng (Network Error) khi không gọi được API
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    throw new Error("Không thể kết nối đến máy chủ. Vui lòng kiểm tra đường truyền mạng.");
                }
                throw error; // Ném tiếp lỗi đã xử lý ở trên ra ngoài
            }
        }

        // Logic xử lý giao diện
        const forgotForm = document.getElementById('forgot-form');
        const statusMessage = document.getElementById('status-message');
        const submitButton = document.getElementById('submit-button');

        forgotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();

            if (!email) {
                showError("Vui lòng nhập địa chỉ email.");
                return;
            }
            
            // UI Loading state
            setLoading(true);

            try {
                const response = await forgotPassword(email);
                
                // Thành công
                showSuccess("Đường dẫn đặt lại mật khẩu đã được gửi! Vui lòng kiểm tra hộp thư đến (hoặc mục Spam).");
                
                // Tùy chọn: Xóa form sau khi gửi thành công
                // document.getElementById('email').value = ''; 

            } catch (error) {
                // Hiển thị lỗi (đã được Việt hóa)
                showError(error.message);
            } finally {
                // Reset UI state
                setLoading(false);
            }
        });

        // Các hàm hỗ trợ UI
        function showError(msg) {
            statusMessage.textContent = msg;
            statusMessage.className = 'status-message error';
            statusMessage.style.display = 'block';
        }

        function showSuccess(msg) {
            statusMessage.textContent = msg;
            statusMessage.className = 'status-message success';
            statusMessage.style.display = 'block';
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                submitButton.textContent = 'Đang xử lý...';
                statusMessage.style.display = 'none';
            } else {
                submitButton.disabled = false;
                submitButton.textContent = 'Gửi link xác nhận';
            }
        }
    </script>
</body>
</html>