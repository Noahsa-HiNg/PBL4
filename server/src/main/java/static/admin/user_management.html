<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tài khoản | Admin Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css"> 
    <style>
        /* === 1. CSS CHUẨN HÓA BUTTON (ĐỒNG BỘ VỚI CLIENT SETUP) === */
        :root {
            --btn-primary-bg: #007bff;
            --btn-primary-hover: #0056b3;
            --btn-secondary-bg: #6c757d;
            --btn-secondary-hover: #545b62;
            --btn-danger-bg: #dc3545;
            --btn-danger-hover: #c82333;
            --btn-info-bg: #17a2b8;
            --btn-info-hover: #138496;
            --btn-success-bg: #28a745;
            --btn-success-hover: #218838;
        }

        /* Class cơ sở cho mọi nút */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: white;
            white-space: nowrap;
        }
        
        /* Kích thước nhỏ cho bảng */
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.85rem; }

        /* Các màu sắc */
        .btn-primary { background-color: var(--btn-primary-bg); }
        .btn-primary:hover { background-color: var(--btn-primary-hover); }

        .btn-secondary { background-color: var(--btn-secondary-bg); }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover); }

        .btn-danger { background-color: var(--btn-danger-bg); }
        .btn-danger:hover { background-color: var(--btn-danger-hover); }

        .btn-info { background-color: var(--btn-info-bg); }
        .btn-info:hover { background-color: var(--btn-info-hover); }

        .btn-success { background-color: var(--btn-success-bg); }
        .btn-success:hover { background-color: var(--btn-success-hover); }

        /* Nhóm nút trong bảng để căn hàng ngang đẹp */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: flex-start;
        }

        /* === 2. CÁC STYLE KHÁC === */
        .metrics-grid { 
            display: flex; gap: 20px; margin-bottom: 30px; 
            justify-content: space-around;
        }
        .metric-card { 
            text-align: center; padding: 15px; border-radius: 8px; 
            background-color: var(--color-background-surface); box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
            min-width: 180px;
        }
        .metric-value { font-size: 1.8em; font-weight: bold; margin: 5px 0 0; }

        .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .user-table th, .user-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .user-table th { background-color: #f2f2f2; color: #333; }
        
        /* Modal Styles */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; 
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px;
        }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        
        /* Footer Modal để căn nút phải */
        .modal-footer {
            margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;
        }
        
        .role-admin { font-weight: bold; color: var(--btn-primary-bg); }
    </style>
</head>
<body>
    <header class="app-header">
        <a href="../live_feed.html" class="logo">HiAn</a>
        <nav>
            <a href="admin_dashboard.html">Thống kê</a>
            <a href="user_management.html" >Quản lý người dùng</a>
            <a href="admin_setting.html">Cài đặt Cá nhân</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">Quản lý Tài khoản Người dùng</h1>
        
        <div class="metrics-grid" id="user-metrics-area">
            </div>

        <button id="add-user-btn" class="btn btn-success">➕ Thêm Tài khoản Mới</button>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Clients</th>
                    <th>Cameras</th>
                    <th style="width: 200px;">Hành động</th> </tr>
            </thead>
            <tbody id="user-list">
                <tr><td colspan="7" style="text-align: center;">Đang tải danh sách người dùng...</td></tr>
            </tbody>
        </table>
    </main>

    <div class="modal-overlay" id="user-modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <form id="user-form">
                <input type="hidden" id="form-user-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="form-username">Tên đăng nhập</label>
                        <input type="text" id="form-username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="form-email">Email</label>
                        <input type="email" id="form-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="form-password">Mật khẩu (Mới/Đặt lại)</label>
                        <input type="password" id="form-password" class="form-control"> 
                    </div>
                    <div class="form-group">
                        <label for="form-role">Vai trò</label>
                        <select id="form-role" class="form-control" required>
                            <option value="ADMIN">ADMIN</option>
                            <option value="VIEWER">VIEWER</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="close-modal-btn">Hủy bỏ</button>
                    <button type="submit" class="btn btn-primary" id="save-user-btn">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/config.js"></script> 
    <script src="../assets/js/api.js"></script>
    <script>
        const userListBody = document.getElementById('user-list');
        const modal = document.getElementById('user-modal');
        const userForm = document.getElementById('user-form');
        const modalTitle = document.getElementById('modal-title');
        const currentAdminUsername = localStorage.getItem('username'); 
        let userStatsMap = {}; 
        
        async function getUserStats(userId) {
            const url = `${API_BASE_URL}/users/${userId}/stats`; 
            const response = await fetch(url, { method: 'GET', headers: getAuthHeaders() });
            if (!response.ok) return { totalClients: '?', totalCameras: '?' };
            return await response.json();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userRole = localStorage.getItem('role');
            if (userRole !== 'ADMIN') { 
                alert("Bạn không có quyền truy cập trang này.");
                window.location.href = '../live_feed.html';
                return;
            }
            loadUsers();
            
            document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
            document.getElementById('close-modal-btn').addEventListener('click', () => modal.style.display = 'none');
        });

        // ---------------------------------------------
        // 1. Tải Danh sách Users
        // ---------------------------------------------
        async function loadUsers() {
            try {
                const users = await getUserList(); 
                const statsPromises = users.map(user => getUserStats(user.id).then(stats => ({ id: user.id, stats })));
                const allStats = await Promise.all(statsPromises);
                allStats.forEach(item => userStatsMap[item.id] = item.stats);
                renderUserTable(users);
            } catch (error) {
                console.error('Lỗi khi tải danh sách người dùng:', error);
                userListBody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">Không thể tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        // ---------------------------------------------
        // 2. Render Bảng Users (ĐÃ CẬP NHẬT BUTTON)
        // ---------------------------------------------
        function renderUserTable(users) {
            userListBody.innerHTML = '';

            users.forEach(user => {
                const stats = userStatsMap[user.id] || { totalClients: '?', totalCameras: '?' };
                const isCurrentAdmin = (user.username === currentAdminUsername);
                const roleClass = user.role === 'ADMIN' ? 'role-admin' : '';
                const isAdminAccount = (user.role === 'ADMIN');

                const row = userListBody.insertRow();
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td class="${roleClass}">${user.role}</td>
                    <td>${stats.totalClients}</td>
                    <td>${stats.totalCameras}</td>
                    <td>
                        <div class="action-buttons">
                            ${!isCurrentAdmin ? `
                                <a href="user_detail.html?id=${user.id}" class="btn btn-info btn-sm" title="Xem chi tiết">
                                    Xem
                                </a>
                                <button class="btn btn-primary btn-sm" onclick="openUserModal(${user.id})" title="Chỉnh sửa">
                                    Sửa
                                </button>
                                ${!isAdminAccount ? 
                                    `<button class="btn btn-danger btn-sm" onclick="handleDeleteUser(${user.id}, '${user.username}', '${user.role}')" title="Xóa tài khoản">
                                        Xóa
                                    </button>` 
                                    : '' 
                                }
                            ` : '<span style="color: var(--btn-success-bg); font-weight: bold; padding: 5px;">Tài khoản của bạn</span>'}
                        </div>
                    </td>
                `;
            });
        }
        
        // ---------------------------------------------
        // 3. Xử lý Modal
        // ---------------------------------------------
        async function openUserModal(userId = null) {
            userForm.reset();
            modal.style.display = 'flex';
            document.getElementById('form-username').disabled = false; 
            document.getElementById('form-password').required = true; 
            
            if (userId) {
                modalTitle.textContent = 'Sửa Tài khoản';
                try {
                    const user = await getUserById(userId); 
                    document.getElementById('form-user-id').value = user.id;
                    document.getElementById('form-username').value = user.username;
                    document.getElementById('form-username').disabled = true; 
                    document.getElementById('form-email').value = user.email;
                    document.getElementById('form-role').value = user.role;
                    document.getElementById('form-password').required = false; 
                } catch (error) {
                    alert('Lỗi tải chi tiết user: ' + error.message);
                    modal.style.display = 'none';
                }
            } else {
                modalTitle.textContent = 'Thêm Tài khoản Mới';
            }
        }
        
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-user-id').value;
            const isEditing = !!id;
            
            const userData = {
                username: document.getElementById('form-username').value,
                email: document.getElementById('form-email').value,
                password: document.getElementById('form-password').value, 
                role: document.getElementById('form-role').value
            };
            
            if (isEditing && !userData.password) {
                delete userData.password; 
            }

            try {
                let result;
                if (isEditing) {
                    result = await updateUser(id, userData);
                } else {
                    result = await createUser(userData);
                }
                
                alert(`Thành công: Đã ${isEditing ? 'cập nhật' : 'thêm'} user ${result.username || userData.username}`);
                modal.style.display = 'none';
                loadUsers(); 

            } catch (error) {
                alert(`Lỗi: ${error.message}`);
            }
        });

        // ---------------------------------------------
        // 4. Xử lý Xóa User
        // ---------------------------------------------
        async function handleDeleteUser(userId, username, role) {
            if (role === 'ADMIN') {
                alert("Không thể xóa tài khoản có quyền Quản trị viên (ADMIN)!");
                return;
            }

            if (!confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}"? \nHành động này không thể hoàn tác.`)) {
                return;
            }
            
            try {
                await deleteUser(userId); 
                loadUsers(); 
            } catch (error) {
                console.error('Lỗi khi xóa người dùng:', error);
                alert(`Xóa thất bại: ${error.message}`);
            }
        }
    </script>
</body>
</html>