<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn Admin</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth.js"></script> 
    <style>
        /* === CSS C≈® === */
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 1200px; margin: 30px auto; }
        .admin-card { padding: 25px; border: 1px solid var(--color-border); border-radius: var(--border-radius-main); text-align: center; background: var(--color-background-surface); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .metric-value { font-size: 2rem; font-weight: bold; color: var(--color-primary); margin-top: 10px; }
        
        /* === CSS CHO BI·ªÇU ƒê·ªí === */
        .chart-section {
            max-width: 1200px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--color-border);
        }
        .chart-container {
            position: relative; 
            height: 350px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·ªÉ bi·ªÉu ƒë·ªì hi·ªÉn th·ªã ƒë·∫πp */
            width: 100%;
        }

        /* === CSS B·∫¢NG X·∫æP H·∫†NG === */
        .ranking-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 40px auto;
        }

        .ranking-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 4px solid var(--color-primary);
        }

        .ranking-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .ranking-table { width: 100%; border-collapse: collapse; }
        .ranking-table th, .ranking-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .ranking-table th { color: #666; font-size: 0.9rem; }
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; background: #eee; font-size: 0.8rem; font-weight: bold; }
        .rank-1 { background-color: #ffd700; color: #fff; }
        .rank-2 { background-color: #c0c0c0; color: #fff; }
        .rank-3 { background-color: #cd7f32; color: #fff; }
        .loading-text { color: #999; font-style: italic; }
    </style>
</head>
<body>
   <header class="app-header">
        <a href="admin_dashboard.html" class="logo">HiAn Admin</a>
        <nav>
            <a href="admin_dashboard.html" class="active">Dashboard</a>
            <a href="user_management.html">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
            <a href="admin_setting.html">C√†i ƒë·∫∑t</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">T·ªïng quan H·ªá th·ªëng</h1>
        
        <div class="metrics-grid admin-grid">
            <div class="admin-card metric-card">
                <h2>Users</h2>
                <p id="metric-users" class="metric-value">...</p>
            </div>
            <div class="admin-card metric-card">
                <h2>Clients</h2>
                <p id="metric-clients" class="metric-value">...</p>
            </div>
            <div class="admin-card metric-card">
                <h2>Cameras</h2>
                <p id="metric-total-cameras" class="metric-value">...</p>
            </div>
            <div class="admin-card metric-card">
                <h2>T·ªïng ·∫¢nh</h2>
                <p id="metric-total-images" class="metric-value">...</p>
            </div>
            <div class="admin-card metric-card" style="border-color: green;">
                <h2 style="color: green">Cam Online</h2>
                <p id="metric-active-cameras" class="metric-value">...</p>
            </div>
        </div>

        <div class="chart-section">
            <h2 class="page-title" style="margin-top: 0; margin-bottom: 20px; font-size: 1.3rem;">üìä Th·ªëng k√™ ·∫£nh 30 ng√†y qua</h2>
            <div class="chart-container">
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>
        
        <h2 class="page-title" style="margin-top: 40px;">B·∫£ng X·∫øp H·∫°ng Th√†nh Vi√™n</h2>
        <div class="ranking-container">
            <div class="ranking-card">
                <h3 class="ranking-title">üèÜ Top T·∫£i L√™n Nhi·ªÅu Nh·∫•t</h3>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>T√™n ng∆∞·ªùi d√πng</th>
                            <th style="text-align: right;">S·ªë ·∫£nh</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-images-body">
                        <tr><td colspan="3" class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="ranking-card">
                <h3 class="ranking-title">üì∑ Top S·ªü H·ªØu Camera</h3>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>T√™n ng∆∞·ªùi d√πng</th>
                            <th style="text-align: right;">S·ªë Camera</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-cameras-body">
                        <tr><td colspan="3" class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h2 class="page-title" style="margin-top: 40px;">C√¥ng c·ª• Qu·∫£n tr·ªã</h2>
        <div class="admin-grid">
            <a href="user_management.html" class="admin-card" style="text-decoration: none; color: inherit;">
                <h2>Qu·∫£n l√Ω T√†i kho·∫£n (CRUD)</h2>
                <p style="margin-top: 10px; color: #666;">Th√™m, s·ª≠a, x√≥a, t√¨m ki·∫øm ng∆∞·ªùi d√πng.</p>
            </a>
        </div>
    </main>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>
    <script>
        // Bi·∫øn to√†n c·ª•c bi·ªÉu ƒë·ªì
        let myChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            const userRole = localStorage.getItem('role');
            if (userRole !== 'ADMIN') {
                alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
                window.location.href = '../live_feed.html'; 
                return;
            }
            
            // T·∫£i d·ªØ li·ªáu
            loadAdminMetrics();
            loadAdminRankings();
            loadChartData(); // <--- G·ªçi h√†m t·∫£i bi·ªÉu ƒë·ªì
        });

        // --- 1. T·∫¢I METRICS ---
        async function loadAdminMetrics() {
            // L∆ØU √ù: ƒê√£ ƒë·ªïi URL th√†nh /api/dashboard/... ƒë·ªÉ kh·ªõp v·ªõi Backend m·ªõi
            const metricsUrl = `${API_BASE_URL}/admin/metrics`; 
            
            try {
                const response = await fetch(metricsUrl, { method: 'GET', headers: getAuthHeaders() });
                if (!response.ok) throw new Error("L·ªói t·∫£i metrics");
                const metrics = await response.json();

                document.getElementById('metric-users').textContent = metrics.totalUsers;
                document.getElementById('metric-clients').textContent = metrics.totalClients;
                document.getElementById('metric-total-cameras').textContent = metrics.totalCameras;
                document.getElementById('metric-total-images').textContent = metrics.totalImages ? metrics.totalImages.toLocaleString() : 0;
                document.getElementById('metric-active-cameras').textContent = metrics.activeCameras;
            } catch (error) {
                console.error("L·ªói metrics:", error);
            }
        }

        // --- 2. T·∫¢I RANKINGS ---
        async function loadAdminRankings() {
            const rankingUrl = `${API_BASE_URL}/admin/rankings?limit=5`; 

            try {
                const response = await fetch(rankingUrl, { method: 'GET', headers: getAuthHeaders() });
                if (!response.ok) throw new Error("L·ªói t·∫£i rankings");
                const data = await response.json();
                
                renderRankingTable('ranking-images-body', data.topUsersByImages);
                renderRankingTable('ranking-cameras-body', data.topUsersByCameras);
            } catch (error) {
                console.error("L·ªói rankings:", error);
                document.getElementById('ranking-images-body').innerHTML = `<tr><td colspan="3" style="color:red">L·ªói t·∫£i</td></tr>`;
                document.getElementById('ranking-cameras-body').innerHTML = `<tr><td colspan="3" style="color:red">L·ªói t·∫£i</td></tr>`;
            }
        }

        // --- 3. T·∫¢I D·ªÆ LI·ªÜU BI·ªÇU ƒê·ªí (M·ªöI) ---
        async function loadChartData() {
            const chartUrl = `${API_BASE_URL}/admin/chart-data`; // Endpoint m·ªõi

            try {
                const response = await fetch(chartUrl, { method: 'GET', headers: getAuthHeaders() });
                if (!response.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì");
                
                // D·ªØ li·ªáu tr·∫£ v·ªÅ l√† List<DailyImageStats> [{dateStr: '15/12', countVal: 10}, ...]
                const dataList = await response.json();

                // T√°ch th√†nh 2 m·∫£ng cho Chart.js
                const labels = dataList.map(item => item.dateStr);
                const values = dataList.map(item => item.countVal);

                renderChart(labels, values);

            } catch (error) {
                console.error("L·ªói bi·ªÉu ƒë·ªì:", error);
                // V·∫Ω bi·ªÉu ƒë·ªì tr·ªëng ho·∫∑c th√¥ng b√°o l·ªói
            }
        }

        // --- 4. V·∫º BI·ªÇU ƒê·ªí CHART.JS ---
        function renderChart(labels, dataPoints) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (myChart) myChart.destroy(); // X√≥a bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥

            myChart = new Chart(ctx, {
                type: 'bar', // D·∫°ng c·ªôt
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng ·∫£nh',
                        data: dataPoints,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)', // Xanh d∆∞∆°ng
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, // ·∫®n ch√∫ th√≠ch v√¨ ch·ªâ c√≥ 1 c·ªôt
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'S·ªë ·∫£nh' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Helper render b·∫£ng
        function renderRankingTable(elementId, dataList) {
            const tbody = document.getElementById(elementId);
            tbody.innerHTML = ''; 
            if (!dataList || dataList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }
            dataList.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const row = `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                        <td><strong>${item.username}</strong></td>
                        <td style="text-align: right; font-weight: bold;">${item.value.toLocaleString()}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }
    </script>
</body>
</html>