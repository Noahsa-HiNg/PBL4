<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cài đặt Tài khoản</title>
    <link rel="stylesheet" href="/assets/css/style.css"> 
    <script src="/assets/js/auth.js"></script> 
    <style>
        .settings-container { max-width: 600px; }
        #status-message { margin-top: 1rem; display: none; }
        /* Style để vô hiệu hóa input */
        input:disabled {
            background-color: var(--color-background-muted);
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <a href="live_feed.html" class="logo">HiAn</a>
        <nav>
            <a href="live_feed.html">Live Feed</a>
            <a href="client_setup.html">Client Setup</a>
            <a href="snapshot_management.html">Snapshot Management</a>
            <a href="user_settings.html">Settings</a>
        </nav>
    </header>

    <main>
        <div class="settings-container">
            <h1 class="page-title">Cài đặt Tài khoản</h1>
            <form id="settings-form">
                <input type="hidden" id="userId"> 
                <div class="form-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" class="form-control" disabled> 
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                
                <div class="form-actions" style="margin-top: 1rem; display: flex; gap: 10px; align-items: center;">
                    <button type="submit" class="btn btn-primary" id="update-button">Cập nhật Thông tin</button>
                    <a href="change_password.html" class="btn" style="background-color: #6c757d; color: white; text-decoration: none; padding: 10px 20px; border-radius: 4px; display: inline-block; text-align: center;">
                        Đổi Mật Khẩu
                    </a>
                </div>
                
                <p id="status-message"></p>
            </form>
            
            <hr style="margin: 2.5rem 0;">
            
            <button class="btn btn-danger" id="logout-btn">Đăng xuất</button>
        </div>
    </main>

    <footer class="app-footer">
        <span>© 2025 Surveillance System. All rights reserved.</span>
        <nav>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
            <a href="#">Contact Us</a>
        </nav>
    </footer>

    <script src="/assets/js/config.js"></script> 
    <script src="/assets/js/api.js"></script> 
    <script>
        const settingsForm = document.getElementById('settings-form');
        const logoutBtn = document.getElementById('logout-btn');
        const statusMessage = document.getElementById('status-message');
        const updateButton = document.getElementById('update-button');
        const userIdInput = document.getElementById('userId');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');

        // --- 1. KHAI BÁO BIẾN TOÀN CỤC (SỬA LỖI TẠI ĐÂY) ---
        let currentUserId = null; 
        let userCurrentEmail = ''; // Biến để lưu email cũ

        // Tải thông tin user hiện tại khi trang load
        document.addEventListener('DOMContentLoaded', async () => {
            // Kiểm tra token trước
            const token = localStorage.getItem('authToken');
            if (!token) {
                 window.location.href = 'login.html';
                 return;
            }

            // Hiển thị link admin nếu là admin
            if (localStorage.getItem('role') === 'ADMIN') {
                 const adminLink = document.getElementById('admin-link-users');
                 if (adminLink) adminLink.style.display = 'inline-block';
            }
            
            try {
                if (typeof getCurrentUser !== 'function') throw new Error("API 'getCurrentUser' không tồn tại.");
                
                const user = await getCurrentUser();
                
                if (user) {
                    currentUserId = user.id;
                    userIdInput.value = user.id;
                    usernameInput.value = user.username;
                    
                    // --- 2. GÁN GIÁ TRỊ CHO BIẾN TOÀN CỤC ---
                    emailInput.value = user.email || '';
                    userCurrentEmail = user.email || ''; // Lưu lại để so sánh khi submit
                } else {
                     throw new Error("Không lấy được thông tin người dùng.");
                }
            } catch (error) {
                showStatus("Lỗi tải thông tin user: " + error.message, true);
                updateButton.disabled = true;
            }
        });

        // Xử lý Cập nhật
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;

            const newEmail = emailInput.value.trim();
            
            // --- 3. KIỂM TRA LOGIC VỚI BIẾN ĐÃ KHAI BÁO ---
            if (newEmail === userCurrentEmail) { 
                showStatus("Bạn chưa thay đổi email nào.", true);
                return;
            }

            updateButton.disabled = true;
            updateButton.textContent = 'Đang xử lý...';
            statusMessage.style.display = 'none';

            try {
                const token = localStorage.getItem('authToken');
                const url = `${API_BASE_URL}/users/${currentUserId}/request-email-change`; 

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ email: newEmail })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`Đã gửi liên kết xác thực tới ${newEmail}. Vui lòng kiểm tra hộp thư (cả mục Spam) để hoàn tất.`, false);
                    updateButton.style.display = 'none'; 
                } else if (response.status === 409) {
                    showStatus("Email này đã được sử dụng bởi tài khoản khác. Vui lòng chọn email khác.", true);
                } else {
                    throw new Error(data.message || "Lỗi cập nhật.");
                }

            } catch (error) {
                showStatus(error.message, true);
            } finally {
                if(updateButton.style.display !== 'none') {
                    updateButton.disabled = false;
                    updateButton.textContent = 'Cập nhật Thông tin';
                }
            }
        });

        // Xử lý Đăng xuất
        logoutBtn.addEventListener('click', async () => {
            // Xóa hết storage
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            localStorage.removeItem('role');
            localStorage.removeItem('id');
            localStorage.removeItem('username');
            
            // Chuyển hướng
            window.location.href = 'login.html';
        });

        // Hàm hiển thị thông báo
        function showStatus(message, isError = false) {
             statusMessage.textContent = message;
             statusMessage.style.color = isError ? 'red' : 'green';
             statusMessage.style.display = 'block';
        }
    </script>
</body>
</html>