<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thư viện ảnh - Hệ thống Giám sát</title>
    
    <link rel="stylesheet" href="/assets/css/style.css"> 
    
    <style>
        /* === TÙY CHỈNH BỘ LỌC === */
        .filter-controls {
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            margin-bottom: 20px; 
            align-items: center;
            background: var(--color-background-main);
            padding: 15px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .filter-controls .form-control { min-width: 180px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.85rem; color: var(--color-text-secondary); }

        /* === THANH CÔNG CỤ (SELECT ALL) === */
        .grid-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .select-all-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        #select-all-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* === GIAO DIỆN LƯỚI (GRID GALLERY) === */
        .image-grid-container {
            display: grid;
            /* Tự động chia cột, mỗi cột tối thiểu 160px, tự co giãn */
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .image-grid-item {
            position: relative;
            background-color: var(--color-gray-100);
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1 / 1; /* Tỉ lệ khung hình vuông 1:1 */
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .image-grid-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .image-grid-item.selected {
            border-color: var(--color-primary);
            background-color: var(--color-primary-light);
        }

        .image-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cắt ảnh để vừa khít khung vuông */
            transition: transform 0.3s;
        }

        .image-grid-item:hover img {
            transform: scale(1.05); /* Zoom nhẹ khi hover */
        }

        /* Checkbox nổi trên ảnh */
        .grid-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            z-index: 10;
            cursor: pointer;
            /* Tạo bóng để dễ nhìn trên nền ảnh sáng */
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.8));
        }

        /* Thông tin phủ dưới ảnh (Gradient) */
        .grid-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 20px 10px 10px 10px;
            font-size: 0.8rem;
            pointer-events: none; /* Để click xuyên qua vào ảnh */
        }

        .grid-info-overlay .camera-name { font-weight: bold; display: block; }
        .grid-info-overlay .time { font-size: 0.75rem; opacity: 0.9; }

        /* === THANH HÀNH ĐỘNG XÓA HÀNG LOẠT === */
        .batch-actions {
            display: none; 
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 20px;
            background-color: var(--color-primary-light);
            border-radius: var(--border-radius-main);
            color: var(--color-primary-dark);
            border: 1px solid var(--color-primary);
        }
        #batch-delete-btn {
            background-color: var(--color-status-danger);
            color: white;
        }

        .loading-placeholder {
            grid-column: 1 / -1; /* Chiếm hết chiều ngang lưới */
            text-align: center;
            padding: 3rem;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        /* === PHÂN TRANG === */
        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }
        .pagination-controls .btn:disabled {
            background-color: var(--color-gray-300);
            cursor: not-allowed;
            opacity: 0.7;
        }
        #page-info { font-weight: 600; }

        /* === MODAL (Giữ nguyên) === */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.9); padding-top: 50px; }
        .modal-content { position: relative; background-color: var(--color-background-main); margin: auto; padding: 0; border-radius: var(--border-radius-main); width: 90%; max-width: 900px; animation-name: animatetop; animation-duration: 0.4s; }
        @keyframes animatetop { from {top: -50px; opacity: 0} to {top: 0; opacity: 1} }
        .modal-header { padding: 1rem 1.5rem; background-color: var(--color-background-muted); border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; border-radius: var(--border-radius-main) var(--border-radius-main) 0 0; }
        .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 0; display: flex; flex-direction: column; }
        .modal-image-container { background-color: black; display: flex; justify-content: center; align-items: center; height: 60vh; }
        .modal-image-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-details { padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--color-border); }
        .modal-info-text p { margin: 5px 0; }
        .modal-actions { display: flex; gap: 10px; }
        #modal-delete-btn { background-color: var(--color-status-danger); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .modal-image-container { 
    background-color: #ffffff; /* Nền trắng */
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 60vh; 
    border-bottom: 1px solid #e0e0e0; /* Đường kẻ mờ ngăn cách với phần tin */
    padding: 20px;
}

/* Ảnh trong modal: Thêm bóng đổ để nổi bật trên nền trắng */
.modal-image-container img { 
    max-width: 100%; 
    max-height: 100%; 
    object-fit: contain; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* Đổ bóng nhẹ */
    border-radius: 4px;
}

/* Phần thông tin chi tiết: Nền trắng, chữ đen */
.modal-details { 
    background-color: #ffffff;
    padding: 20px 30px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-radius: 0 0 var(--border-radius-main) var(--border-radius-main);
}

/* Chữ thông tin: To hơn, màu đen rõ ràng */
.modal-info-text {
    display: flex;
    flex-direction: column;
    gap: 8px; /* Khoảng cách giữa các dòng */
}

.modal-info-text p { 
    margin: 0; 
    color: #333333; /* Màu xám đen đậm */
    font-size: 1.1rem; /* Cỡ chữ to hơn */
    line-height: 1.5;
}

.modal-info-text strong {
    color: #000000; /* Tiêu đề đậm đen hoàn toàn */
    font-weight: 700;
    margin-right: 5px;
    min-width: 80px; /* Canh thẳng hàng tiêu đề */
    display: inline-block;
}

/* Nút bấm trong modal */
.modal-actions { 
    display: flex; 
    gap: 15px; 
}
    </style>
</head>
<body>
    <header class="app-header">
        <a href="live_feed.html" class="logo">HiAn</a>
        <nav>
            <a href="live_feed.html">Live Feed</a>
            <a href="client_setup.html">Client Setup</a>
            <a href="snapshot_management.html" class="active">Snapshot Management</a>
            <a href="user_settings.html">Settings</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">Kho ảnh</h1>
        
        <div class="filter-controls">
            <div class="filter-group">
                <label for="client-filter">Camera</label>
                <select id="client-filter" class="form-control">
                    <option value="all">-- Tất cả --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="start-date">Từ ngày</label>
                <input type="datetime-local" id="start-date" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="end-date">Đến ngày</label>
                <input type="datetime-local" id="end-date" class="form-control">
            </div>

            <button class="btn btn-primary" id="apply-filter-btn" style="align-self: flex-end;">Lọc</button>
            <button class="btn btn-secondary" id="clear-filter-btn" style="align-self: flex-end;">Xóa lọc</button>
        </div>

        <div class="batch-actions" id="batch-actions-bar">
            <span id="batch-selected-count">Đã chọn 0 ảnh</span>
            <button class="btn" id="batch-delete-btn">Xóa mục đã chọn</button>
        </div>

        <div class="grid-toolbar">
            <label class="select-all-wrapper">
                <input type="checkbox" id="select-all-checkbox">
                <span>Chọn tất cả trang này</span>
            </label>
            <span id="total-results-count" style="color: var(--color-text-secondary); font-size: 0.9rem;"></span>
        </div>

        <div class="image-grid-container" id="image-list-body">
            <p class="loading-placeholder">Đang tải thư viện ảnh...</p>
        </div>
        
        <div class="pagination-controls" id="pagination-controls">
            <button class="btn btn-secondary" id="prev-page-btn" disabled>&#8592; Trước</button>
            <span id="page-info">1 / 1</span>
            <button class="btn btn-secondary" id="next-page-btn" disabled>Sau &#8594;</button>
        </div>
    </main>

    <div id="image-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-image-name">Chi tiết ảnh</h3>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-image-container">
                    <img id="modal-image-src" src="" alt="Chi tiết ảnh">
                </div>
                <div class="modal-details">
                    <div class="modal-info-text">
                        <p><strong>Camera:</strong> <span id="modal-image-camera"></span></p>
                        <p><strong>Thời gian:</strong> <span id="modal-image-time"></span></p>
                    </div>
                    <div class="modal-actions">
                        <a href="#" download id="modal-download-btn" class="btn btn-primary">Tải về</a>
                        <button id="modal-delete-btn">Xóa ảnh</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/api.js"></script> 
    <script src="/assets/js/websocket.js"></script>

    <script>
        // === DOM ELEMENTS ===
        const listBody = document.getElementById('image-list-body');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');
        const totalResultsCount = document.getElementById('total-results-count');
        
        // Modal elements
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image-src');
        const modalName = document.getElementById('modal-image-name');
        const modalCamera = document.getElementById('modal-image-camera');
        const modalTime = document.getElementById('modal-image-time');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const closeModalBtn = document.querySelector('.modal .close-btn');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        
        // Filter elements
        const clientFilterSelect = document.getElementById('client-filter');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');

        // Batch delete elements
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const batchActionsBar = document.getElementById('batch-actions-bar');
        const batchSelectedCount = document.getElementById('batch-selected-count');
        const batchDeleteBtn = document.getElementById('batch-delete-btn');

        // === STATE ===
        let currentPage = 0;
        let currentCameraId = null;
        let currentStartDate = null;
        let currentEndDate = null;
        let selectedImageIds = new Set();

        // === INIT ===
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFilterOptions();
            loadImages(currentPage);
            setupEventListeners();
            if (localStorage.getItem('authToken')) {
                // connectWebSocket(); // Uncomment nếu có dùng socket
            }
        });

        // ----------------------------------------------------
        // LOGIC TẢI DỮ LIỆU
        // ----------------------------------------------------
        async function loadFilterOptions() {
            try {
                const clients = await getClientList();
                const cameraPromises = clients.map(client => getCameraListByClient(client.id));
                const allCameras = await Promise.all(cameraPromises);
                
                clients.forEach((client, index) => {
                    const clientGroup = document.createElement('optgroup');
                    clientGroup.label = `Client: ${client.clientName}`;
                    clientFilterSelect.appendChild(clientGroup);

                    const cameras = allCameras[index];
                    cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.id; 
                        option.textContent = `${camera.cameraName} (ID: ${camera.id})`;
                        clientGroup.appendChild(option);
                    });
                });
            } catch (error) {
                console.error("Lỗi tải tùy chọn lọc:", error);
            }
        }

        async function loadImages(page) {
            currentPage = page; 
            listBody.innerHTML = '<p class="loading-placeholder">Đang tải thư viện ảnh...</p>'; 
            
            try {
                const size = 24; // Tăng số lượng ảnh để đẹp hơn trên Grid
                
                const pageData = await getImageList(
                    page, 
                    size, 
                    currentCameraId, 
                    currentStartDate, 
                    currentEndDate
                ); 

                if (!pageData.content || pageData.content.length === 0) {
                    listBody.innerHTML = '<p class="loading-placeholder">Không tìm thấy ảnh nào.</p>';
                    updatePagination(pageData); 
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.disabled = true;
                    updateBatchDeleteUI();
                    if(totalResultsCount) totalResultsCount.textContent = '(0 ảnh)';
                    return;
                }

                listBody.innerHTML = ''; 
                selectAllCheckbox.disabled = false;
                if(totalResultsCount) totalResultsCount.textContent = `(Tổng: ${pageData.totalElements} ảnh)`;

                pageData.content.forEach(image => {
                    const timestamp = new Date(image.capturedAt).toLocaleString('vi-VN');
                    const isChecked = selectedImageIds.has(image.id.toString());
                    const activeClass = isChecked ? 'selected' : '';

                    // === RENDER DẠNG GRID ITEM (THUMBNAIL) ===
                    const itemHTML = `
                        <div class="image-grid-item ${activeClass}" 
                             data-id="${image.id}" 
                             data-src="${image.filePath}" 
                             data-name="Snapshot ID ${image.id}" 
                             data-camera="${image.cameraId}" 
                             data-time="${timestamp}">
                            
                            <input type="checkbox" class="image-checkbox grid-checkbox" 
                                   data-id="${image.id}" ${isChecked ? 'checked' : ''}>
                            
                            <img src="${image.filePath}" loading="lazy" alt="ID ${image.id}">
                            
                            <div class="grid-info-overlay">
                                <span class="camera-name">Cam ${image.cameraId}</span>
                                <span class="time">${new Date(image.capturedAt).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                        </div>
                    `;
                    listBody.insertAdjacentHTML('beforeend', itemHTML);
                });

                updatePagination(pageData);
                updateBatchDeleteUI();
                updateSelectAllCheckboxState();

            } catch (error) {
                console.error('Lỗi khi tải thư viện ảnh:', error);
                listBody.innerHTML = `<p class="loading-placeholder" style="color: var(--color-status-danger);">Lỗi: ${error.message}</p>`;
            }
        }

        // ----------------------------------------------------
        // CẬP NHẬT UI
        // ----------------------------------------------------
        function updatePagination(pageData) {
            if (!pageData || pageData.totalPages === 0) {
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                pageInfo.textContent = '1 / 1';
                return;
            }
            pageInfo.textContent = `${pageData.number + 1} / ${pageData.totalPages}`;
            prevPageBtn.disabled = pageData.first; 
            nextPageBtn.disabled = pageData.last;
        }

        function updateBatchDeleteUI() {
            const count = selectedImageIds.size;
            if (count > 0) {
                batchActionsBar.style.display = 'flex';
                batchSelectedCount.textContent = `Đã chọn ${count} ảnh`;
            } else {
                batchActionsBar.style.display = 'none';
            }
        }

        function updateSelectAllCheckboxState() {
            const visibleCheckboxes = document.querySelectorAll('.image-checkbox');
            if(visibleCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                return;
            }
            const allVisibleSelected = Array.from(visibleCheckboxes).every(cb => 
                selectedImageIds.has(cb.dataset.id)
            );
            selectAllCheckbox.checked = allVisibleSelected;
        }

        // ----------------------------------------------------
        // SỰ KIỆN (EVENT LISTENERS)
        // ----------------------------------------------------
        function setupEventListeners() {
            // 1. FILTER
            applyFilterBtn.addEventListener('click', () => {
                currentCameraId = (clientFilterSelect.value === 'all') ? null : parseInt(clientFilterSelect.value);
                currentStartDate = startDateInput.value ? new Date(startDateInput.value).toISOString() : null;
                currentEndDate = endDateInput.value ? new Date(endDateInput.value).toISOString() : null;
                
                if(currentStartDate && currentEndDate && currentEndDate < currentStartDate) {
                    alert("Ngày kết thúc không thể trước ngày bắt đầu.");
                    return;
                }
                loadImages(0); 
            });

            clearFilterBtn.addEventListener('click', () => {
                clientFilterSelect.value = 'all';
                startDateInput.value = '';
                endDateInput.value = '';
                currentCameraId = null;
                currentStartDate = null;
                currentEndDate = null;
                loadImages(0);
            });

            // 2. PHÂN TRANG
            prevPageBtn.addEventListener('click', () => { if (currentPage > 0) loadImages(currentPage - 1); });
            nextPageBtn.addEventListener('click', () => { loadImages(currentPage + 1); });

            // 3. EVENT DELEGATION (Xử lý Click vào Ảnh hoặc Checkbox)
            listBody.addEventListener('click', (event) => {
                const checkbox = event.target.closest('.image-checkbox');
                const gridItem = event.target.closest('.image-grid-item');

                // Trường hợp 1: Click vào Checkbox
                if (checkbox) {
                    // Ngăn sự kiện nổi bọt để không kích hoạt click vào gridItem (mở modal)
                    event.stopPropagation(); 
                    
                    const id = checkbox.dataset.id;
                    if (checkbox.checked) {
                        selectedImageIds.add(id);
                        gridItem.classList.add('selected');
                    } else {
                        selectedImageIds.delete(id);
                        gridItem.classList.remove('selected');
                    }
                    updateBatchDeleteUI();
                    updateSelectAllCheckboxState();
                    return;
                }

                // Trường hợp 2: Click vào Ảnh (Grid Item) -> Mở Modal
                if (gridItem) {
                    // Lấy dữ liệu từ data attributes
                    const imageData = { ...gridItem.dataset };
                    showImageDetails(imageData);
                }
            });
            
            // 4. CHỌN TẤT CẢ
            selectAllCheckbox.addEventListener('click', () => {
                const visibleCheckboxes = document.querySelectorAll('.image-checkbox');
                const isChecked = selectAllCheckbox.checked;
                
                visibleCheckboxes.forEach(cb => {
                    const id = cb.dataset.id;
                    const gridItem = cb.closest('.image-grid-item');
                    if (isChecked) {
                        selectedImageIds.add(id);
                        cb.checked = true;
                        gridItem.classList.add('selected');
                    } else {
                        selectedImageIds.delete(id);
                        cb.checked = false;
                        gridItem.classList.remove('selected');
                    }
                });
                updateBatchDeleteUI();
            });

            // 5. BATCH DELETE
            batchDeleteBtn.addEventListener('click', async () => {
                const ids = Array.from(selectedImageIds);
                if (ids.length === 0) return;
                if (!confirm(`Bạn có chắc muốn xóa ${ids.length} ảnh đã chọn không?`)) return;
                
                try {
                    await deleteBatchImages(ids); 
                    alert('Đã xóa thành công!');
                    selectedImageIds.clear();
                    loadImages(currentPage); 
                } catch (error) {
                    console.error('Lỗi khi xóa hàng loạt:', error);
                    alert(`Không thể xóa: ${error.message}`);
                }
            });

            // 6. MODAL ACTIONS
            closeModalBtn.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });

            modalDeleteBtn.addEventListener('click', async () => {
                const id = modalDeleteBtn.getAttribute('data-delete-id');
                if (!id) return; 
                if (!confirm(`Bạn có chắc muốn xóa ảnh này (ID: ${id}) không?`)) return;

                try {
                    await deleteImage(id); 
                    alert('Đã xóa ảnh thành công!');
                    selectedImageIds.delete(id);
                    closeModal(); 
                    loadImages(currentPage); 
                } catch (error) {
                    console.error('Lỗi khi xóa ảnh:', error);
                    alert(`Không thể xóa ảnh: ${error.message}`);
                }
            });
        }

        // ----------------------------------------------------
        // MODAL FUNCTIONS
        // ----------------------------------------------------
        // ----------------------------------------------------
// MODAL FUNCTIONS (Đã cập nhật)
// ----------------------------------------------------
function showImageDetails(data) {
    modalName.textContent = `Chi tiết: ${data.name || 'Snapshot'}`;
    modalName.style.color = '#000'; // Đảm bảo tiêu đề màu đen
    modalImg.src = data.src;
    modalCamera.textContent = data.camera ? `${data.camera}` : 'Không xác định';
    modalTime.textContent = data.time ? `${data.time}` : '--:--';

    // 4. Cập nhật Nút hành động
    modalDeleteBtn.setAttribute('data-delete-id', data.id);
    
    modalDownloadBtn.href = data.src;
    const safeTimeStr = data.time.replace(/[:\/\s]/g, '_'); 
    modalDownloadBtn.download = `snapshot_cam${data.camera}_${safeTimeStr}.jpg`;
    
    // 5. Hiển thị Modal
    modal.style.display = 'block';
}

        function closeModal() {
            modal.style.display = 'none';
            modalImg.src = ""; 
        }
    </script>
</body>
</html>