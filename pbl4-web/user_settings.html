<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cài đặt Tài khoản</title>
    <link rel="stylesheet" href="/assets/css/style.css"> <script src="/assets/js/auth.js"></script> <style>
        .settings-container { max-width: 600px; }
        #status-message { margin-top: 1rem; display: none; }
        /* Style để vô hiệu hóa input */
        input:disabled {
            background-color: var(--color-background-muted);
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <a href="live_feed.html" class="logo">■ Surveillance System</a>
        <nav>
            <a href="live_feed.html">Live Feed</a>
            <a href="client_setup.html">Client Setup</a>
            <a href="snapshot_management.html">Snapshot Management</a>
            <a href="user_settings.html">Settings</a>
        </nav>
    </header>

    <main>
        <div class="settings-container">
            <h1 class="page-title">Cài đặt Tài khoản</h1>
            <form id="settings-form">
                <input type="hidden" id="userId"> <div class="form-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" class="form-control" disabled> </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                
                <button type="submit" class="btn btn-primary" id="update-button">Cập nhật Thông tin</button>
                <p id="status-message"></p>
            </form>
            
            <hr style="margin: 2.5rem 0;">
            
            <button class="btn btn-danger" id="logout-btn">Đăng xuất</button>
        </div>
    </main>

    <footer class="app-footer">
        <span>© 2025 Surveillance System. All rights reserved.</span>
        <nav>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
            <a href="#">Contact Us</a>
        </nav>
    </footer>

    <script src="/assets/js/config.js"></script> <script src="/assets/js/api.js"></script> <script>
        const settingsForm = document.getElementById('settings-form');
        const logoutBtn = document.getElementById('logout-btn');
        const statusMessage = document.getElementById('status-message');
        const updateButton = document.getElementById('update-button');
        const userIdInput = document.getElementById('userId');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');

        let currentUserId = null; // Biến lưu ID user đang đăng nhập

        // Tải thông tin user hiện tại khi trang load
        document.addEventListener('DOMContentLoaded', async () => {
            // Hiển thị link admin nếu là admin
            if (localStorage.getItem('role') === 'ADMIN') {
                 const adminLink = document.getElementById('admin-link-users');
                 if (adminLink) adminLink.style.display = 'inline-block';
            }
            
            try {
                // Gọi /api/auth/me để lấy user hiện tại
                if (typeof getCurrentUser !== 'function') throw new Error("API 'getCurrentUser' không tồn tại.");
                const user = await getCurrentUser();
                if (user && user.id) { // Giả sử API /me trả về cả ID
                    currentUserId = user.id; // Lưu ID lại
                    userIdInput.value = user.id;
                    usernameInput.value = user.username;
                    emailInput.value = user.email || '';
                } else if (user && user.username) { // Nếu API /me chỉ trả username/role (như mock)
                     usernameInput.value = user.username;
                     // Cần gọi API khác để lấy ID và email nếu cần sửa
                     // Hoặc đơn giản hóa: dùng username để update nếu API cho phép
                     console.warn("API /me không trả về ID, cần gọi API khác để lấy ID user.");
                     // Giả lập lấy ID từ mockUserId nếu dùng mock
                     currentUserId = localStorage.getItem('mockUserId');
                     userIdInput.value = currentUserId;
                     // Nếu đang dùng mock, ta có thể gọi getUserById để lấy email
                     if (currentUserId && typeof getUserById === 'function') {
                         const fullUser = await getUserById(currentUserId);
                         emailInput.value = fullUser.email || '';
                     } else {
                        updateButton.disabled = true; // Không có ID, không cho cập nhật
                     }

                } else {
                     throw new Error("Không lấy được thông tin người dùng.");
                }
            } catch (error) {
                showStatus("Lỗi tải thông tin user: " + error.message, true);
                updateButton.disabled = true; // Vô hiệu hóa nút cập nhật nếu lỗi
            }
        });

        // Xử lý Cập nhật
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) {
                showStatus("Không xác định được ID người dùng để cập nhật.", true);
                return;
            }

            const dataToUpdate = {
                email: emailInput.value.trim()
                // Chỉ gửi email, không gửi username/password/role
                // Nếu có đổi password, thêm vào đây:
                // password: newPasswordValue (nếu có)
            };
            statusMessage.style.display = 'none';
            updateButton.disabled = true;
            updateButton.textContent = 'Đang lưu...';

            try {
                if (typeof updateUser !== 'function') throw new Error("API 'updateUser' không tồn tại.");
                // Gọi API cập nhật user với ID đã lấy được
                await updateUser(currentUserId, dataToUpdate);
                showStatus("Cập nhật thông tin thành công!", false);
            } catch (error) {
                showStatus(error.message || "Cập nhật thất bại.", true);
            } finally {
                 updateButton.disabled = false;
                 updateButton.textContent = 'Cập nhật Thông tin';
            }
        });

        // Xử lý Đăng xuất
        logoutBtn.addEventListener('click', async () => {
            try {
                 if (typeof logoutUser !== 'function') throw new Error("Hàm 'logoutUser' không tồn tại.");
                await logoutUser(); // Gọi hàm logout từ api.js (xóa token)
                // auth.js sẽ tự động chuyển hướng nếu cần, hoặc ta chuyển hướng ở đây
                 if (typeof window !== 'undefined' && window.location.pathname.split('/').pop() !== 'login.html') {
                    window.location.href = 'login.html'; // Quay về trang login
                 }
            } catch (error) {
                console.error("Lỗi khi đăng xuất:", error);
                alert("Lỗi đăng xuất.");
            }
        });

        // Hàm hiển thị thông báo
        function showStatus(message, isError = false) {
             statusMessage.textContent = message;
             statusMessage.style.color = isError ? 'var(--color-status-danger)' : 'var(--color-status-success)';
             statusMessage.style.display = 'block';
        }
    </script>
</body>
</html>