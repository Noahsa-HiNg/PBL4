<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tài khoản | Admin Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css"> 
    <style>
        /* CSS cho Grid/Modal */
        .metrics-grid { 
            display: flex; gap: 20px; margin-bottom: 30px; 
            justify-content: space-around;
        }
        .metric-card { 
            text-align: center; padding: 15px; border-radius: 8px; 
            background-color: var(--color-background-surface); box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
            min-width: 180px;
        }
        .metric-value { font-size: 1.8em; font-weight: bold; margin: 5px 0 0; }

        .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .user-table th, .user-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .user-table th { background-color: #f2f2f2; color: #333; }
        .btn-add { margin-bottom: 20px; padding: 10px 15px; background-color: #28a745; color: white; border: none; }
        .btn-edit { background-color: #007bff; color: white; border: none; }
        
        /* Modal Styles */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; 
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px;
        }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    </style>
</head>
<body>
    <header class="app-header">
        <a href="../live_feed.html" class="logo">■ Surveillance System</a>
        <nav>
            <a href="admin_dashboard.html">Admin Dashboard</a>
            <a href="user_management.html" class="active">Quản lý User</a>
            <a href="admin_settings.html">Cài đặt Cá nhân</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">Quản lý Tài khoản Người dùng</h1>
        
        <div class="metrics-grid" id="user-metrics-area">
            </div>

        <button id="add-user-btn" class="btn btn-add">➕ Thêm Tài khoản Mới</button>
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Clients</th>
                    <th>Cameras</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="user-list">
                <tr><td colspan="7" style="text-align: center;">Đang tải danh sách người dùng...</td></tr>
            </tbody>
        </table>
    </main>

    <div class="modal-overlay" id="user-modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <form id="user-form">
                <input type="hidden" id="form-user-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="form-username">Tên đăng nhập</label>
                        <input type="text" id="form-username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="form-email">Email</label>
                        <input type="email" id="form-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="form-password">Mật khẩu (Mới/Đặt lại)</label>
                        <input type="password" id="form-password" class="form-control"> 
                    </div>
                    <div class="form-group">
                        <label for="form-role">Vai trò</label>
                        <select id="form-role" class="form-control" required>
                            <option value="ADMIN">ADMIN</option>
                            <option value="VIEWER">VIEWER</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="save-user-btn">Lưu</button>
                <button type="button" class="btn btn-secondary" id="close-modal-btn">Hủy</button>
            </form>
        </div>
    </div>

    <script src="../assets/js/config.js"></script> 
    <script src="../assets/js/api.js"></script>
    <script>
        const userListBody = document.getElementById('user-list');
        const errorMessageDiv = document.getElementById('error-message');
        const modal = document.getElementById('user-modal');
        const userForm = document.getElementById('user-form');
        const modalTitle = document.getElementById('modal-title');
        const currentAdminUsername = localStorage.getItem('username'); 
        let userStatsMap = {}; // Lưu trữ số liệu thống kê user: {id: {clients: 5, cameras: 10}}
        
        // Cần hai hàm mới (giả định)
        async function getUserStats(userId) {
            const url = `${API_BASE_URL}/users/${userId}/stats`; 
            const response = await fetch(url, { method: 'GET', headers: getAuthHeaders() });
            if (!response.ok) return { totalClients: '?', totalCameras: '?' };
            return await response.json();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra quyền truy cập (giữ nguyên)
            const userRole = localStorage.getItem('role');
            if (userRole !== 'ADMIN') { 
                alert("Bạn không có quyền truy cập trang này.");
                window.location.href = '../live_feed.html';
                return;
            }
            loadUsers();
            
            // Xử lý nút Thêm Tài khoản
            document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
            document.getElementById('close-modal-btn').addEventListener('click', () => modal.style.display = 'none');
        });

        // ---------------------------------------------
        // 1. Tải Danh sách Users và Stats
        // ---------------------------------------------
        async function loadUsers() {
            try {
                // Tải danh sách User (chỉ gọi 1 lần)
                const users = await getUserList(); 
                
                // Tải số liệu thống kê cho TẤT CẢ Users (bất đồng bộ)
                const statsPromises = users.map(user => getUserStats(user.id).then(stats => ({ id: user.id, stats })));
                const allStats = await Promise.all(statsPromises);
                
                // Gán stats vào map
                allStats.forEach(item => userStatsMap[item.id] = item.stats);

                renderUserTable(users);
                
            } catch (error) {
                console.error('Lỗi khi tải danh sách người dùng:', error);
                userListBody.innerHTML = `<tr><td colspan="7" class="error-message">Không thể tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        // ---------------------------------------------
        // 2. Render Bảng Users
        // ---------------------------------------------
        function renderUserTable(users) {
            userListBody.innerHTML = '';

            users.forEach(user => {
                const stats = userStatsMap[user.id] || { totalClients: '?', totalCameras: '?' };
                const isCurrentAdmin = (user.username === currentAdminUsername);
                const roleClass = user.role === 'ADMIN' ? 'role-admin' : '';
                
                const row = userListBody.insertRow();
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td class="${roleClass}">${user.role}</td>
                    <td>${stats.totalClients}</td>
                    <td>${stats.totalCameras}</td>
                    <td class="user-actions">
                        ${!isCurrentAdmin ? `
                            <button class="btn btn-edit btn-sm" onclick="openUserModal(${user.id})">Sửa</button>
                            <button class="btn btn-delete btn-sm" onclick="handleDeleteUser(${user.id}, '${user.username}')">Xóa</button>
                        ` : 'Tài khoản của bạn'}
                    </td>
                `;
            });
        }
        
        // ---------------------------------------------
        // 3. Xử lý Modal (Thêm/Sửa)
        // ---------------------------------------------
        async function openUserModal(userId = null) {
            userForm.reset();
            modal.style.display = 'flex';
            document.getElementById('form-username').disabled = false; // Mặc định cho thêm mới
            document.getElementById('form-password').required = true; // Mật khẩu bắt buộc khi thêm
            
            if (userId) {
                modalTitle.textContent = 'Sửa Tài khoản Người dùng';
                try {
                    const user = await getUserById(userId); // Lấy chi tiết user
                    document.getElementById('form-user-id').value = user.id;
                    document.getElementById('form-username').value = user.username;
                    document.getElementById('form-username').disabled = true; // Không cho sửa username
                    document.getElementById('form-email').value = user.email;
                    document.getElementById('form-role').value = user.role;
                    document.getElementById('form-password').required = false; // Không bắt buộc mật khẩu khi sửa
                } catch (error) {
                    alert('Lỗi tải chi tiết user: ' + error.message);
                    modal.style.display = 'none';
                }
            } else {
                modalTitle.textContent = 'Thêm Tài khoản Mới';
            }
        }
        
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-user-id').value;
            const isEditing = !!id;
            
            // Lấy dữ liệu
            const userData = {
                username: document.getElementById('form-username').value,
                email: document.getElementById('form-email').value,
                // Chỉ gửi password nếu là thêm mới HOẶC nếu người dùng đã nhập password mới
                password: document.getElementById('form-password').value, 
                role: document.getElementById('form-role').value
            };
            
            // Xóa trường password nếu là sửa và không nhập gì mới
            if (isEditing && !userData.password) {
                delete userData.password; 
            }

            try {
                let result;
                if (isEditing) {
                    result = await updateUser(id, userData);
                } else {
                    result = await createUser(userData);
                }
                
                alert(`Thành công: Đã ${isEditing ? 'cập nhật' : 'thêm'} user ${result.username || userData.username}`);
                modal.style.display = 'none';
                loadUsers(); // Tải lại bảng

            } catch (error) {
                alert(`Lỗi: ${error.message}`);
            }
        });

        // ---------------------------------------------
        // 4. Xử lý Xóa User
        // ---------------------------------------------
        async function handleDeleteUser(userId, username) {
            if (!confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}"?`)) {
                return;
            }
            
            try {
                await deleteUser(userId); // Sử dụng hàm đã có trong api.js

                alert(`Đã xóa User ID: ${userId} (${username}) thành công!`);
                loadUsers(); // Tải lại danh sách

            } catch (error) {
                console.error('Lỗi khi xóa người dùng:', error);
                alert(`Xóa thất bại: ${error.message}`);
            }
        }

    </script>
</body>
</html>