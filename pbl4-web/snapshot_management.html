<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kho ảnh đã chụp - Hệ thống Giám sát</title>
    
    <link rel="stylesheet" href="/assets/css/style.css"> 
    
    <style>
        /* === TÙY CHỈNH BỘ LỌC === */
        .filter-controls {
            display: flex; 
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
            gap: 15px; 
            margin-bottom: 20px; 
            align-items: center;
        }
        .filter-controls .form-control {
            min-width: 200px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* === GIAO DIỆN DANH SÁCH MỚI === */
        .image-list-container {
            width: 100%;
            background-color: var(--color-background-muted);
            border-radius: var(--border-radius-main);
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .image-list-header, .image-list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            gap: 1rem;
        }
        
        .image-list-header {
            background-color: var(--color-gray-100);
            font-weight: 600;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .image-list-item {
            background-color: var(--color-background-main);
            transition: background-color 0.2s;
        }
        .image-list-item:hover {
            background-color: var(--color-gray-100);
        }
        
        /* Cấu hình các cột */
        .col-check { flex: 0 0 30px; }
        .col-thumb { 
            flex: 0 0 70px; /* 60px cho ảnh + 10px lề */
        }
        .col-id { flex: 0 0 80px; }
        .col-camera { flex: 1 1 120px; }
        .col-time { flex: 1 1 180px; }
        .col-actions { flex: 0 0 80px; text-align: right; }

        .list-thumbnail {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: var(--border-radius-main, 4px);
            background-color: var(--color-gray-300);
        }

        .image-list-item .col-id strong {
            color: var(--color-primary);
        }

        .image-list-item .details-btn {
            background: none;
            border: none;
            color: var(--color-primary);
            cursor: pointer;
            font-weight: 600;
            padding: 5px;
        }
        .image-list-item .details-btn:hover {
            text-decoration: underline;
        }
        
        .image-checkbox, #select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* === THANH HÀNH ĐỘNG XÓA HÀNG LOẠT === */
        .batch-actions {
            display: none; /* Ẩn mặc định, JS sẽ hiện */
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 20px;
            background-color: var(--color-primary-light);
            border-radius: var(--border-radius-main);
            color: var(--color-primary-dark);
        }
        #batch-delete-btn {
            background-color: var(--color-status-danger);
            color: white;
        }

        .loading-placeholder {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
        }

        /* === PHÂN TRANG === */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }
        .pagination-controls .btn:disabled {
            background-color: var(--color-gray-300);
            cursor: not-allowed;
            opacity: 0.7;
        }
        #page-info { font-weight: 600; }

        /* === MODAL === */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.85); padding-top: 50px; }
        .modal-content { position: relative; background-color: var(--color-background-main); margin: auto; color: var(--color-text-secondary); padding: 0; border-radius: var(--border-radius-main); width: 90%; max-width: 800px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); animation-name: animatetop; animation-duration: 0.4s; }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .modal-header { padding: 1rem 1.5rem; background-color: var(--color-background-muted); color: var(--color-text-primary); border-bottom: 1px solid var(--color-border); border-top-left-radius: var(--border-radius-main); border-top-right-radius: var(--border-radius-main); }
        .close-btn { color: var(--color-text-secondary); float: right; font-size: 28px; font-weight: bold; line-height: 1; transition: 0.2s; }
        .close-btn:hover, .close-btn:focus { color: var(--color-text-primary); text-decoration: none; cursor: pointer; }
        .modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .modal-image-container img { width: 100%; height: auto; max-height: 60vh; object-fit: contain; border-radius: var(--border-radius-main); background-color: var(--color-background-muted); }
        .modal-details p { margin: 0.5rem 0; font-size: 1rem; }
        .modal-details strong { color: var(--color-text-secondary); min-width: 100px; display: inline-block; }
        .modal-actions { display: flex; justify-content: flex-end; padding: 1rem 1.5rem; border-top: 1px solid var(--color-border); background-color: var(--color-background-muted); border-bottom-left-radius: var(--border-radius-main); border-bottom-right-radius: var(--border-radius-main); }
        #modal-delete-btn { background-color: var(--color-status-danger); color: white; }
    </style>
</head>
<body>
    <header class="app-header">
        <a href="live_feed.html" class="logo">■ Surveillance System</a>
        <nav>
            <a href="live_feed.html">Live Feed</a>
            <a href="client_setup.html">Client Setup</a>
            <a href="snapshot_management.html" class="active">Snapshot Management</a>
            <a href="user_settings.html">Settings</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">Kho ảnh đã chụp</h1>
        
        <div class="filter-controls">
            <div class="filter-group">
                <label for="client-filter">Lọc theo Camera</label>
                <select id="client-filter" class="form-control">
                    <option value="all">-- Tất cả ảnh của tôi --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="start-date">Từ ngày</label>
                <input type="datetime-local" id="start-date" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="end-date">Đến ngày</label>
                <input type="datetime-local" id="end-date" class="form-control">
            </div>

            <button class="btn btn-primary" id="apply-filter-btn" style="align-self: flex-end;">Lọc</button>
            <button class="btn btn-secondary" id="clear-filter-btn" style="align-self: flex-end;">Xóa lọc</button>
        </div>

        <div class="batch-actions" id="batch-actions-bar">
            <span id="batch-selected-count">Đã chọn 0 ảnh</span>
            <button class="btn" id="batch-delete-btn">Xóa các ảnh đã chọn</button>
        </div>

        <div class="image-list-container">
            <div class="image-list-header">
                <div class="col-check">
                    <input type="checkbox" id="select-all-checkbox" title="Chọn tất cả">
                </div>
                <div class="col-thumb">Xem trước</div>
                <div class="col-id">Snapshot ID</div>
                <div class="col-camera">Camera</div>
                <div class="col-time">Thời gian chụp</div>
                <div class="col-actions">Chi tiết</div>
            </div>
            <div id="image-list-body">
                <p class="loading-placeholder">Đang tải thư viện ảnh...</p>
            </div>
        </div>
        
        <div class="pagination-controls" id="pagination-controls">
            <button class="btn btn-secondary" id="prev-page-btn" disabled>Trang trước</button>
            <span id="page-info">Trang 1 / 1</span>
            <button class="btn btn-secondary" id="next-page-btn" disabled>Trang sau</button>
        </div>
    </main>

    <div id="image-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn">&times;</span>
                <h2 id="modal-image-name">Chi tiết ảnh</h2>
            </div>
            <div class="modal-body">
                <div class="modal-image-container">
                    <img id="modal-image-src" src="" alt="Chi tiết ảnh">
                </div>
                <div class="modal-details">
                    <p><strong>Camera ID:</strong> <span id="modal-image-camera"></span></p>
                    <p><strong>Thời gian:</strong> <span id="modal-image-time"></span></p>
                </div>
            </div>
            <div class="modal-actions">
                <a href="#" download id="modal-download-btn" class="btn btn-primary" style="margin-right: 10px;">
                    Tải về
                </a>
                <button class="btn btn-danger" id="modal-delete-btn">Xóa ảnh</button>
            </div>
        </div>
    </div>

    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/api.js"></script> 

    <script>
        // === DOM ELEMENTS ===
        const listBody = document.getElementById('image-list-body');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image-src');
        const modalName = document.getElementById('modal-image-name');
        const modalCamera = document.getElementById('modal-image-camera');
        const modalTime = document.getElementById('modal-image-time');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const closeModalBtn = document.querySelector('.modal .close-btn');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        
        // Filter elements
        const clientFilterSelect = document.getElementById('client-filter');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');

        // Batch delete elements
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const batchActionsBar = document.getElementById('batch-actions-bar');
        const batchSelectedCount = document.getElementById('batch-selected-count');
        const batchDeleteBtn = document.getElementById('batch-delete-btn');

        // === STATE ===
        let currentPage = 0;
        let currentCameraId = null;
        let currentStartDate = null;
        let currentEndDate = null;
        let selectedImageIds = new Set(); // Dùng Set để lưu các ID được chọn

        // === INIT ===
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFilterOptions();
            loadImages(currentPage);
            setupEventListeners();
        });

        // ----------------------------------------------------
        // LOGIC TẢI DỮ LIỆU
        // ----------------------------------------------------
        async function loadFilterOptions() {
            try {
                const clients = await getClientList();
                const cameraPromises = clients.map(client => getCameraListByClient(client.id));
                const allCameras = await Promise.all(cameraPromises);
                
                clients.forEach((client, index) => {
                    const clientGroup = document.createElement('optgroup');
                    clientGroup.label = `Client: ${client.clientName}`;
                    clientFilterSelect.appendChild(clientGroup);

                    const cameras = allCameras[index];
                    cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.id; 
                        option.textContent = `Camera: ${camera.cameraName} (ID: ${camera.id})`;
                        clientGroup.appendChild(option);
                    });
                });
            } catch (error) {
                console.error("Lỗi tải tùy chọn lọc:", error);
            }
        }

        async function loadImages(page) {
            currentPage = page; 
            listBody.innerHTML = '<p class="loading-placeholder">Đang tải thư viện ảnh...</p>'; 
            
            try {
                const size = 10; // Số ảnh mỗi trang
                
                // GỌI API ĐÃ CẬP NHẬT
                const pageData = await getImageList(
                    page, 
                    size, 
                    currentCameraId, 
                    currentStartDate, 
                    currentEndDate
                ); 

                if (!pageData.content || pageData.content.length === 0) {
                    listBody.innerHTML = '<p class="loading-placeholder">Không tìm thấy ảnh nào.</p>';
                    updatePagination(pageData); 
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.disabled = true;
                    updateBatchDeleteUI();
                    return;
                }

                listBody.innerHTML = ''; 
                selectAllCheckbox.disabled = false;

                pageData.content.forEach(image => {
                    const timestamp = new Date(image.capturedAt).toLocaleString('vi-VN');
                    const isChecked = selectedImageIds.has(image.id.toString());

                    // Đã thêm .col-thumb
                    const itemHTML = `
                        <div class="image-list-item" data-id="${image.id}" 
                             data-src="${image.filePath}" 
                             data-name="Snapshot ID ${image.id}" 
                             data-camera="${image.cameraId}" 
                             data-time="${timestamp}">
                            
                            <div class="col-check">
                                <input type="checkbox" class="image-checkbox" 
                                       data-id="${image.id}" ${isChecked ? 'checked' : ''}>
                            </div>
                            
                            <div class="col-thumb">
                                <img src="${image.filePath}" class="list-thumbnail" alt="Snapshot ${image.id}">
                            </div>

                            <div class="col-id"><strong>ID: ${image.id}</strong></div>
                            <div class="col-camera">Camera ${image.cameraId}</div>
                            <div class="col-time">${timestamp}</div>
                            <div class="col-actions">
                                <button class="details-btn">Xem</button>
                            </div>
                        </div>
                    `;
                    listBody.insertAdjacentHTML('beforeend', itemHTML);
                });

                updatePagination(pageData);
                updateBatchDeleteUI();
                updateSelectAllCheckboxState();

            } catch (error) {
                console.error('Lỗi khi tải thư viện ảnh:', error);
                listBody.innerHTML = `<p class="loading-placeholder" style="color: var(--color-status-danger);">Không thể tải thư viện: ${error.message}</p>`;
            }
        }

        // ----------------------------------------------------
        // CẬP NHẬT GIAO DIỆN (UI)
        // ----------------------------------------------------
        function updatePagination(pageData) {
            if (!pageData || pageData.totalPages === 0) {
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                pageInfo.textContent = 'Trang 1 / 1';
                return;
            }
            pageInfo.textContent = `Trang ${pageData.number + 1} / ${pageData.totalPages}`;
            prevPageBtn.disabled = pageData.first; 
            nextPageBtn.disabled = pageData.last;
        }

        function updateBatchDeleteUI() {
            const count = selectedImageIds.size;
            if (count > 0) {
                batchActionsBar.style.display = 'flex';
                batchSelectedCount.textContent = `Đã chọn ${count} ảnh`;
            } else {
                batchActionsBar.style.display = 'none';
            }
        }

        function updateSelectAllCheckboxState() {
            const visibleCheckboxes = document.querySelectorAll('.image-checkbox');
            if(visibleCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                return;
            }
            
            const allVisibleSelected = Array.from(visibleCheckboxes).every(cb => 
                selectedImageIds.has(cb.dataset.id)
            );
            selectAllCheckbox.checked = allVisibleSelected;
        }

        // ----------------------------------------------------
        // LOGIC SỰ KIỆN (Event Listeners)
        // ----------------------------------------------------
        function setupEventListeners() {
            // 1. LỌC
            applyFilterBtn.addEventListener('click', () => {
                currentCameraId = (clientFilterSelect.value === 'all') ? null : parseInt(clientFilterSelect.value);
                
                // Chuyển đổi ngày sang định dạng ISO string, hoặc null
                currentStartDate = startDateInput.value ? new Date(startDateInput.value).toISOString() : null;
                currentEndDate = endDateInput.value ? new Date(endDateInput.value).toISOString() : null;
                
                if(currentStartDate && currentEndDate && currentEndDate < currentStartDate) {
                    alert("Ngày kết thúc không thể trước ngày bắt đầu.");
                    return;
                }
                
                loadImages(0); 
            });

            clearFilterBtn.addEventListener('click', () => {
                clientFilterSelect.value = 'all';
                startDateInput.value = '';
                endDateInput.value = '';
                
                currentCameraId = null;
                currentStartDate = null;
                currentEndDate = null;
                
                loadImages(0);
            });

            // 2. PHÂN TRANG
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 0) loadImages(currentPage - 1);
            });
            nextPageBtn.addEventListener('click', () => {
                loadImages(currentPage + 1);
            });

            // 3. SỰ KIỆN TRÊN DANH SÁCH (Event Delegation)
            listBody.addEventListener('click', (event) => {
                const checkbox = event.target.closest('.image-checkbox');
                const detailsButton = event.target.closest('.details-btn');
                const item = event.target.closest('.image-list-item');

                if (checkbox) {
                    // Click vào checkbox
                    const id = checkbox.dataset.id;
                    if (checkbox.checked) {
                        selectedImageIds.add(id);
                    } else {
                        selectedImageIds.delete(id);
                    }
                    updateBatchDeleteUI();
                    updateSelectAllCheckboxState();

                } else if (detailsButton || (item && !checkbox)) {
                    // Click vào nút "Xem" hoặc vùng item (không phải checkbox)
                    if(item) {
                        const imageData = { ...item.dataset }; // Clone data
                        showImageDetails(imageData);
                    }
                }
            });
            
            // 4. CHỌN TẤT CẢ
            selectAllCheckbox.addEventListener('click', () => {
                const visibleCheckboxes = document.querySelectorAll('.image-checkbox');
                const isChecked = selectAllCheckbox.checked;
                
                visibleCheckboxes.forEach(cb => {
                    const id = cb.dataset.id;
                    if (isChecked) {
                        selectedImageIds.add(id);
                        cb.checked = true;
                    } else {
                        selectedImageIds.delete(id);
                        cb.checked = false;
                    }
                });
                updateBatchDeleteUI();
            });

            // 5. XÓA HÀNG LOẠT
            batchDeleteBtn.addEventListener('click', async () => {
                const ids = Array.from(selectedImageIds);
                if (ids.length === 0) return;

                if (!confirm(`Bạn có chắc muốn xóa ${ids.length} ảnh đã chọn không?`)) return;
                
                try {
                    // Giả định bạn có hàm 'deleteBatchImages' trong api.js
                    await deleteBatchImages(ids); 
                    alert('Đã xóa thành công!');
                    selectedImageIds.clear();
                    loadImages(currentPage); // Tải lại trang
                    updateBatchDeleteUI();
                    
                } catch (error) {
                    console.error('Lỗi khi xóa hàng loạt:', error);
                    alert(`Không thể xóa: ${error.message}`);
                }
            });

            // 6. MODAL (Đóng)
            closeModalBtn.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => {
                if (event.target == modal) closeModal();
            });

            // 7. MODAL: XÓA ẢNH ĐƠN
            modalDeleteBtn.addEventListener('click', async () => {
                const id = modalDeleteBtn.getAttribute('data-delete-id');
                if (!id) return; 
                if (!confirm(`Bạn có chắc muốn xóa ảnh này (ID: ${id}) không?`)) return;

                try {
                    await deleteImage(id); 
                    alert('Đã xóa ảnh thành công!');
                    selectedImageIds.delete(id); // Xóa khỏi set nếu có
                    closeModal(); 
                    loadImages(currentPage); 
                } catch (error) {
                    console.error('Lỗi khi xóa ảnh:', error);
                    alert(`Không thể xóa ảnh: ${error.message}`);
                }
            });
        }

        // ----------------------------------------------------
        // LOGIC MODAL (Hiển thị/Đóng)
        // ----------------------------------------------------
        function showImageDetails(data) {
            modalName.textContent = `Snapshot ID: ${data.id}`;
            modalImg.src = data.src;
            modalImg.alt = `Snapshot ${data.id}`;
            modalCamera.textContent = data.camera;
            modalTime.textContent = data.time;
            
            modalDeleteBtn.setAttribute('data-delete-id', data.id);
            modalDownloadBtn.href = data.src;
            modalDownloadBtn.download = `snapshot_ID${data.id}_${data.camera}.jpg`;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
            modalImg.src = ""; 
            modalDeleteBtn.removeAttribute('data-delete-id'); 
        }

    </script>
</body>
</html>